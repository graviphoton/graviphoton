<!doctype html>
<html>
  <head>
    <title>loading Graviphoton <!-- @echo NODE_ENV --></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- @if NODE_ENV=='production' -->
    <link rel="stylesheet" type="text/css" href="graviphoton.min.css"></link>
    <link rel="stylesheet/less" type="text/css" href="graviphoton.less"></link>
<!-- @endif -->
<!-- @if NODE_ENV=='development' -->
    <!-- @echo CSS_INCLUDES -->
    <!-- @echo LESS_INCLUDES -->
<!-- @endif -->

    <style>
        .cell-title {
          font-weight: bold;
        }
     
        .cell-effort-driven {
          text-align: center;
        }
     
        .cell-selection {
          border-right-color: silver;
          border-right-style: solid;
          background: #f5f5f5;
          color: gray;
          text-align: right;
          font-size: 10px;
        }
     
        .slick-row.selected .cell-selection {
          background-color: transparent; /* show default selected row background */
        }

        .slick-header-column.ui-state-default {
          height: 24px;
        }

        .slick-cell {
          height: 24px !important;
        }
    </style>

    <script type="text/html" id="template-about">
      <div class="container">
        This is Sparta!
      </div>
    </script>
  </head>

  <body id="graviphoton">

    <section>
      <header id="header" class="navbar navbar-default"></header>
      <section id="main" class="main-region container">
       <p class="lead">This is the Graviphoton interface prototype. It aims at showing off how backbone marionette gets used alongside twitter bootstrap to create an app that is pleasing for the developer as well as the user.</p>
       <p>So far everything seems to work out. I'm especially glad that bootstrap and backbone seem to like each other. I also stumbed upon font-awesome again and decided to start using that instead of a sprite sheet. So far this uses the following components.</p>
       <ul>
         <li>underscore.js</li>
         <li>backbone.js</li>
         <li>backbone.marionette</li>
         <li>twitter-bootstrap</li>
         <li>font-awesome</li>
         <li>SlickGrid</li>
       <ul>
      </section>
      <footer id="footer" class="footer-region"></footer>
    </section>

<!-- @if NODE_ENV=='production' -->
    <script type="text/javascript" src="graviphoton.min.js"></script>
    <script type="text/javascript">
      $(function(){
        Graviphoton.start();
      });
    </script>
<!-- @endif -->
<!-- @if NODE_ENV=='development' -->
    <script type="text/javascript" src="templates.js"></script>
    <!-- @echo JS_INCLUDES -->
    <script type="text/javascript">
      $(function(){
        Graviphoton.start();
      });

      $(function () {
 
        function actionBar(row,cell,value,columnDef,dataContext) {
          // the id is so that you can identify the row when the particular button is clicked
          var button = "<input type='button' value='Button' id='" + dataContext.id + '0' + "'>";
          var checkbox = "<input type='checkbox' value='Checkbox' id='" + dataContext.id + '1' + "'>"
          var html = "<a href='http://www.swisscom.ch' id='" + dataContext.id + '2' + "'>" + "swisscom</a>";

          return button + checkbox + html;
        }

        var options = {
          enableCellNavigation: true,
           enableColumnReorder: false,
          forceFitColumns: false,
          topPanelHeight: 30
        };

        var functionLookups = {
          "actionBar" : actionBar,
        }

        $.getJSON("../entris.json", function(data) {
           var columns = data['columns'];
           var data = data['data'];

           // map function names for action bar to real functions
           for (i = 0; i < columns.length; i++) {
             if ("formatter" in columns[i]) {
               columns[i]['formatter'] = functionLookups[columns[i]['formatter']];
             }
           }

           for (i = 0; i < data.length; i++) {
              data[i]['id'] = 'id_' + i;
           }

           var dataView = new Slick.Data.DataView({ inlineFilters: true });
           var grid = new Slick.Grid("#myGrid", dataView, columns, options);
           var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));
           grid.setSelectionModel(new Slick.RowSelectionModel());
           grid.autosizeColumns();
 
           // custom filter function
           function columnFilter(item, args) {
             // check title column
             if (args.searchString != "" && item["KUNDEN_BEZEICHNUNG"].toLowerCase().indexOf(args.searchString.toLowerCase()) == -1) {
               return false;
             }
             return true;
           }

           // show pager setting in the right down corner of the grid
           $(".slick-pager-settings-expanded").show()

           // handler when user presses a key in search text box
           $("#searchTextBox").keyup(function (e) {
             Slick.GlobalEditorLock.cancelCurrentEdit();

             // clear on Esc
             if (e.which == 27) {
               this.value = "";
             }

             dataView.setFilterArgs({
               searchString: this.value
             });
             dataView.refresh();
           });

           // our native compare functions for column KUNDEN_BEZEICHNUNG
           function comparer(a, b) {
             var x = a[sortcol], y = b[sortcol];
             return (x == y ? 0 : (x > y ? 1 : -1));
           }

           // sort event when clicking with mouse on a column title
           grid.onSort.subscribe(function (e, args) {
             sortcol = args.sortCol.field;

             // can be very slow in IE with huge datasets
             dataView.sort(comparer, args.sortAsc);
           });

           // dataView.setItems() fires onRowCountChanged event to display the rows
           dataView.onRowCountChanged.subscribe(function (e, args) {
             grid.updateRowCount();
             grid.render();
           });

           // display new rows when paging
           dataView.onRowsChanged.subscribe(function (e, args) {
             grid.invalidateRows(args.rows);
             grid.render();
           });

           dataView.beginUpdate()
           dataView.setItems(data);
           dataView.setFilterArgs({
             searchString: ""
           });

           // set row filter when entering a search key into search text box.
           dataView.setFilter(columnFilter);

           dataView.endUpdate()
           dataView.syncGridSelection(grid, true);
        });
      })
    </script>
<!-- @endif -->
  </body>
</html>
